{
  "hash": "ce783808961bb30dbc2b99f6c20bb5f6",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Create Demographics Summary\"\nauthor: \"Coco Yu\"\neditor_options:\n  chunk_output_type: console\nparams:\n  study: \"ema\"\n  window: \"1day\"\n  lead: 0\n  version: \"v5\"\n  cv: \"nested\"\n  model: \"main\"\n---\n\n\n### Set Up Environment\n\nSet up parameters as variables\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n(study <- params$study)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"ema\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n(window <- params$window)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"1day\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n(lead <- params$lead)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n(version <- params$version)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"v5\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n(cv <- params$cv)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"nested\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n(model <- params$model)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"main\"\n```\n\n\n:::\n:::\n\n\nFunction conflicts\n\n::: {.cell .hidden}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n#| include: false\n#| echo: false\n\n# source function\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/fun_ml.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"77e91675366f10788c6bcb59fa1cfc9ee0c75281\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n#| include: false\n#| echo: false\n\n# handle conflicts\noptions(conflicts.policy = \"depends.ok\")\ntidymodels_conflictRules()\n```\n:::\n\n\nChunk Defaults\n\n::: {.cell .hidden}\n\n```{.r .cell-code .hidden}\n#| include: false\n\nknitr::opts_chunk$set(attr.output='style=\"max-height: 500px;\"')\n\noptions(tibble.width = Inf)\noptions(tibble.print_max = Inf)\n```\n:::\n\n\nPackages for script\n\n::: {.cell .hidden}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n#| include: false\n#| echo: false\n\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.3     ✔ readr     2.1.4\n✔ forcats   1.0.0     ✔ stringr   1.5.0\n✔ ggplot2   3.4.3     ✔ tibble    3.2.1\n✔ lubridate 1.9.2     ✔ tidyr     1.3.0\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n:::\n\n\nSource support functions\n\n::: {.cell .hidden}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n#| include: false\n#| echo: false\n\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/format_path.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"a58e57da996d1b70bb9a5b58241325d6fd78890f\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n#| include: false\n#| echo: false\n\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/fun_eda.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"c045eee2655a18dc85e715b78182f176327358a7\"\n```\n\n\n:::\n:::\n\n\nAbsolute paths\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\npath_fairema <- format_path(str_c(\"studydata/risk/data_processed/fairema\"))\n```\n:::\n\n\n### Read in data\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ndf <- read_csv(here::here(path_fairema, str_c(\"outer_preds_with_demo_\", window, \"_\", lead,\n                                               \"_\", version, \"_\", cv, \"_\", model, \".csv\")),\n               col_types = cols()) |> \n  mutate(label = factor(label, levels = c(\"Lapse\", \"No lapse\")),\n         predicted = factor(predicted, levels = c(\"Lapse\", \"No lapse\"))) |> glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\nRows: 822,537\nColumns: 24\n$ outer_split_num <dbl> 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, …\n$ threshold       <dbl> 0.136745, 0.136745, 0.136745, 0.136745, 0.136745, 0.13…\n$ subid           <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …\n$ prob_beta       <dbl> 0.01496474, 0.01496474, 0.01496474, 0.01492757, 0.0149…\n$ label           <fct> No lapse, No lapse, No lapse, No lapse, No lapse, No l…\n$ dem_1           <dbl> 57, 57, 57, 57, 57, 57, 57, 57, 57, 57, 57, 57, 57, 57…\n$ dem_2           <chr> \"Male\", \"Male\", \"Male\", \"Male\", \"Male\", \"Male\", \"Male\"…\n$ dem_3           <chr> \"White/Caucasian\", \"White/Caucasian\", \"White/Caucasian…\n$ dem_3_1         <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…\n$ dem_4           <chr> \"No, I am not of Hispanic, Latino, or Spanish origin\",…\n$ dem_4_1         <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…\n$ dem_5           <chr> \"College degree\", \"College degree\", \"College degree\", …\n$ dem_6           <chr> \"Unemployed\", \"Unemployed\", \"Unemployed\", \"Unemployed\"…\n$ dem_6_1         <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…\n$ dem_7           <dbl> 12000, 12000, 12000, 12000, 12000, 12000, 12000, 12000…\n$ dem_8           <chr> \"Never Married\", \"Never Married\", \"Never Married\", \"Ne…\n$ dem2_2          <dbl> 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, …\n$ dem2_4          <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …\n$ dem2_6          <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …\n$ dem2_8          <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …\n$ race            <chr> \"white\", \"white\", \"white\", \"white\", \"white\", \"white\", …\n$ age             <chr> \"older\", \"older\", \"older\", \"older\", \"older\", \"older\", …\n$ income          <chr> \"below_poverty\", \"below_poverty\", \"below_poverty\", \"be…\n$ predicted       <fct> No lapse, No lapse, No lapse, No lapse, No lapse, No l…\n```\n\n\n:::\n:::\n\n\n### Create Table\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ndemographics <- df |> \n  select(c(\"dem_2\", \"race\", \"income\", \"age\", \"subid\")) |> \n  rename(sex = dem_2) |>\n  unique() |> \n  select(-subid) |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\nRows: 151\nColumns: 4\n$ sex    <chr> \"Male\", \"Female\", \"Female\", \"Male\", \"Female\", \"Male\", \"Male\", \"…\n$ race   <chr> \"white\", \"white\", \"white\", \"white\", \"white\", \"white\", \"white\", …\n$ income <chr> \"below_poverty\", \"above_poverty\", \"above_poverty\", \"above_pover…\n$ age    <chr> \"older\", \"younger\", \"younger\", \"younger\", \"younger\", \"younger\",…\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\noutput <- rbind(\n  data.frame(table(demographics$sex)),\n  data.frame(table(demographics$race)),\n  data.frame(table(demographics$income)),\n  data.frame(table(demographics$age))\n)\n\noutput$demographics <- rep(c(\"sex\", \"race\", \"income\", \"age\"), each = 2)\noutput <- output |> \n  rename(subgroup = Var1, N = Freq) |> \n  relocate(demographics)\noutput <- output[c(2, 1, 4, 3, 5, 6, 8, 7),]\noutput |> print_kbl()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div style=\"border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:500px; overflow-x: scroll; width:100%; \"><table class=\"table table-striped table-condensed\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;position: sticky; top:0; background-color: #FFFFFF;\">   </th>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;\"> demographics </th>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;\"> subgroup </th>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;\"> N </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 2 </td>\n   <td style=\"text-align:right;\"> sex </td>\n   <td style=\"text-align:right;\"> Male </td>\n   <td style=\"text-align:right;\"> 77 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1 </td>\n   <td style=\"text-align:right;\"> sex </td>\n   <td style=\"text-align:right;\"> Female </td>\n   <td style=\"text-align:right;\"> 74 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 4 </td>\n   <td style=\"text-align:right;\"> race </td>\n   <td style=\"text-align:right;\"> white </td>\n   <td style=\"text-align:right;\"> 131 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3 </td>\n   <td style=\"text-align:right;\"> race </td>\n   <td style=\"text-align:right;\"> non_white </td>\n   <td style=\"text-align:right;\"> 20 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 5 </td>\n   <td style=\"text-align:right;\"> income </td>\n   <td style=\"text-align:right;\"> above_poverty </td>\n   <td style=\"text-align:right;\"> 102 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 6 </td>\n   <td style=\"text-align:right;\"> income </td>\n   <td style=\"text-align:right;\"> below_poverty </td>\n   <td style=\"text-align:right;\"> 49 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 8 </td>\n   <td style=\"text-align:right;\"> age </td>\n   <td style=\"text-align:right;\"> younger </td>\n   <td style=\"text-align:right;\"> 130 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 7 </td>\n   <td style=\"text-align:right;\"> age </td>\n   <td style=\"text-align:right;\"> older </td>\n   <td style=\"text-align:right;\"> 21 </td>\n  </tr>\n</tbody>\n</table></div>\n\n`````\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| label: barplot\n\nggplot(output, aes(subgroup, N, fill=demographics)) +\n  geom_col() +\n  theme_classic() +\n  theme(axis.text.x=element_text(angle = 30, vjust = 0.7)) +\n  scale_fill_brewer(palette = \"Dark2\")\n```\n\n::: {.cell-output-display}\n![](demographics_files/figure-html/barplot-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| label: pie chart detailed label\n\nggplot(data = output,\n       aes(x = \"\", y = N, fill = subgroup)) + \n  geom_bar(stat=\"identity\", width=1) +\n  coord_polar(\"y\", start=0) +\n  scale_fill_manual(values = c(\"Male\" = \"#6CAA2F\",\n                               \"Female\" = \"#C23E28\",\n                               \"white\" = \"#6CAA2F\",\n                               \"non_white\" = \"#C23E28\",\n                               \"above_poverty\" = \"#6CAA2F\",\n                               \"below_poverty\" = \"#C23E28\",\n                               \"younger\" = \"#6CAA2F\",\n                               \"older\" = \"#C23E28\")) +\n  geom_text(aes(label = subgroup), position = position_stack(vjust = 0.5)) +\n  theme_void() +\n  theme(legend.position=\"none\") +\n  facet_wrap(~demographics) +\n  theme(strip.text.x = element_text(size = 14))\n```\n\n::: {.cell-output-display}\n![](demographics_files/figure-html/pie chart detailed label-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| label: pie chart pivileged/unprivileged\n\noutput |> \n  mutate(\n    subgroup = case_when(\n      subgroup == \"Female\" ~ \"unprivileged\",\n      subgroup == \"Male\" ~ \"privileged\",\n      subgroup == \"white\" ~ \"privileged\",\n      subgroup == \"non_white\" ~ \"unprivileged\",\n      subgroup == \"above_poverty\" ~ \"privileged\",\n      subgroup == \"below_poverty\" ~ \"unprivileged\",\n      subgroup == \"younger\" ~ \"privileged\",\n      subgroup == \"older\" ~ \"unprivileged\"\n    )\n  ) |> \n  ggplot(aes(x = \"\", y = N, fill = subgroup)) + \n  geom_bar(stat=\"identity\", width=1) +\n  coord_polar(\"y\", start=0) +\n  scale_fill_manual(values = c(\"privileged\" = \"#6CAA2F\",\n                               \"unprivileged\" = \"#C23E28\")) +\n  geom_text(aes(label = subgroup), position = position_stack(vjust = 0.5)) +\n  theme_void() +\n  theme(legend.position=\"none\") +\n  facet_wrap(~demographics) +\n  theme(strip.text.x = element_text(size = 14))\n```\n\n::: {.cell-output-display}\n![](demographics_files/figure-html/pie chart pivileged/unprivileged-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| label: pie chart function\n\ndemo_summary <- function(attribute){\n  df <- data.frame(table(demographics[attribute]))\n  names(df) <- c(\"group\", \"value\")\n  \n  df |> \n  arrange(desc(group)) |> \n  mutate(prop = value / sum(df$value) *100) |> \n  mutate(ypos = cumsum(prop)- 0.5*prop )\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| label: pie chart\nplot1 <- ggplot(data = data.frame(table(demographics$sex)),\n       aes(x = \"\", y = Freq, fill = Var1)) + \n  geom_bar(stat=\"identity\", width=1) +\n  coord_polar(\"y\", start=0) +\n  scale_fill_manual(values = c(\"Male\" = \"#6CAA2F\",\n                               \"Female\" = \"#C23E28\")) +\n  geom_text(aes(label = Var1), position = position_stack(vjust = 0.5)) +\n  theme_void() +\n  theme(legend.position=\"none\")\nplot1 <- gridExtra::grid.arrange(plot1, bottom = \"Sex\")\n```\n\n::: {.cell-output-display}\n![](demographics_files/figure-html/pie chart-1.png){width=672}\n:::\n\n```{.r .cell-code .hidden}\n#| label: pie chart\nplot2 <- ggplot(data = data.frame(table(demographics$race)),\n       aes(x = \"\", y = Freq, fill = Var1)) + \n  geom_bar(stat=\"identity\", width=1) +\n  coord_polar(\"y\", start=0) +\n  scale_fill_manual(values = c(\"white\" = \"#6CAA2F\",\n                               \"non_white\" = \"#C23E28\")) +\n  geom_text(aes(label = Var1), position = position_stack(vjust = 0.5)) +\n  theme_void() +\n  theme(legend.position=\"none\")\nplot2 <- gridExtra::grid.arrange(plot2, bottom = \"Race\")\n```\n\n::: {.cell-output-display}\n![](demographics_files/figure-html/pie chart-2.png){width=672}\n:::\n\n```{.r .cell-code .hidden}\n#| label: pie chart\nplot3 <- ggplot(data = data.frame(table(demographics$income)),\n       aes(x = \"\", y = Freq, fill = Var1)) + \n  geom_bar(stat=\"identity\", width=1) +\n  coord_polar(\"y\", start=0) +\n  scale_fill_manual(values = c(\"above_poverty\" = \"#6CAA2F\",\n                               \"below_poverty\" = \"#C23E28\")) +\n  geom_text(aes(label = Var1), position = position_stack(vjust = 0.5)) +\n  theme_void() +\n  theme(legend.position=\"none\")\nplot3 <- gridExtra::grid.arrange(plot3, bottom = \"Income\")\n```\n\n::: {.cell-output-display}\n![](demographics_files/figure-html/pie chart-3.png){width=672}\n:::\n\n```{.r .cell-code .hidden}\n#| label: pie chart\nplot4 <- ggplot(data = data.frame(table(demographics$age)),\n       aes(x = \"\", y = Freq, fill = Var1)) + \n  geom_bar(stat=\"identity\", width=1) +\n  coord_polar(\"y\", start=0) +\n  scale_fill_manual(values = c(\"younger\" = \"#6CAA2F\",\n                               \"older\" = \"#C23E28\")) +\n  geom_text(aes(label = Var1), position = position_stack(vjust = 0.5)) +\n  theme_void() +\n  theme(legend.position=\"none\")\nplot4 <- gridExtra::grid.arrange(plot4, bottom = \"Age\")\n```\n\n::: {.cell-output-display}\n![](demographics_files/figure-html/pie chart-4.png){width=672}\n:::\n\n```{.r .cell-code .hidden}\n#| label: pie chart\ncowplot::plot_grid(plot1, plot2, plot3, plot4)\n```\n\n::: {.cell-output-display}\n![](demographics_files/figure-html/pie chart-5.png){width=672}\n:::\n:::\n",
    "supporting": [
      "demographics_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}